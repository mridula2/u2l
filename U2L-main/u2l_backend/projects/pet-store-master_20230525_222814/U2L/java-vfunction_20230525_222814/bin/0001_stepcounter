#!/bin/sh
#
# $Header: /data/cvsrepo/assess-tools/bin/0001_stepcounter,v 1.9 2016/08/26 02:18:22 meguro Exp $
# $Name: rev_1_10 $
#
# ツール名 : 0001_stepcounter
# 概要     : C, pc, sh, Makefile の行数計算ツール
# 実行方法 : 0001_stepcounter  File
# 入力	   : File  :   対象ファイルリスト(0000_classify_filesの出力結果)
# 出力     : 対象ファイルの種別、ライン数、空行、コメント行、全行数をcsv でstdout に出力
#		/xxx/xxx.csh,CShell,,56,13,62,131
#

trap 'rm -f $nname;exit 1' 2 3 9 15

uname
if [ "`uname`" = "HP-UX" ];
then
	JAVA=/opt/java6/bin/java
else
	JAVA=/usr/bin/java
fi

if [ -f $1 ];
then
	FILE=$1
else
	echo "Usage : $0 File"
	exit 1
fi

# 0000_classify_filesから出力されたファイルかどうかを確認
suffix=`basename $FILE | sed 's/_.*//'`
if [ "`echo $suffix | grep -v '^awk$' | grep -v '^csh$' | grep -v '^ksh$' | grep -v '^cpp$' | grep -v '^exclude$' |  \
	grep -v '^java$' |  grep -v '^php$' |  grep -v '^build$' | grep -v '^c$' | grep -v '^build$' | \
	grep -v '^make$' | grep -v ${APNAME}`" != "" ];
then
	echo "File is not 0000_classify_files output."
	exit 1
fi

for i in `cat $FILE`
do
	# ファイル名を出力
	if [ "`uname`" = "HP-UX" ];
	then
		echo "$i,\c"
	else
		echo -n "$i,"
	fi
	# suffix がstepcounterに対応していないスクリプトの対応
	# 一時的に対応しているsuffixに変更してカウントするように修正
	bname=`basename $i`
	ext=${bname##*.}
	nname="$bname.$suffix"
	if [ $ext != $suffix ]; then
		cp $i $nname
		i=$nname
	fi
	$JAVA -Xms256m -Xmx256m -cp $PJHOME/bin/stepcounter.jar tk.stepcounter.Main -format=csv $i | cut -d, -f2-
	rm -f $nname 2> /dev/null
done
