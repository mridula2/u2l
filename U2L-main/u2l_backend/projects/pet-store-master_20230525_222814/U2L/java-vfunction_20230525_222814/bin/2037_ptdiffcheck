#!/usr/bin/perl
#
# $Header: /data/cvsrepo/assess-tools/bin/2037_ptdiffcheck,v 1.3 2014/01/22 09:49:38 morimoto Exp $
# $Name: rev_1_10 $
#
# ツール名 : 2037_ptdiffcheck
# 概要     : プロトタイプ宣言挿入前後のログ差異確認ツール
# 実行方法 : 2037_ptdiffcheck CA_log PT_log CA_dir PT_dir
# 入力	   : CA_log : 警告番号ごとのプロトタイプ宣言追加前のCAログ
#	   : PT_log : 警告番号ごとのプロトタイプ宣言追加後のCAログ
#	   : CA_dir : CA source directory
#	   : PT_dir : PT source directory
# 出力     : 以下の形式でなくなった警告(DELETE)、増えた警告(ADD)を追加して出力
#		DELETE:xxx.c, line 855: warning #2181-D: ...
#		ADD:xxx.c, line 999: warning #2009-D: ...

my $calog_fname;
my $ptlog_fname;
my $addnum = 0;
my $delnum = 0;

#
#  Main
#
if ( $#ARGV != 3 ) {
	die "Usage : $0 CA_log PT_log CA_dir PT_dir\n";
}	
else {
	$calog_fname = $ARGV[0];
	$ptlog_fname = $ARGV[1];
	$ca_dir = $ARGV[2];
	$pt_dir = $ARGV[3];
}

( -f $calog_fname ) || die "Can't open $calog_fname";
( -f $ptlog_fname ) || die "Can't open $ptlog_fname";

open(my $fh, "$calog_fname") || die "Can't execute diff.";
my @calogs = <$fh>;
close($fh);

open(my $fh, "$ptlog_fname") || die "Can't execute diff.";

my $printed = 0;
while(<$fh>) {
#	chomp;
	my $tgt = $_;
	$tgt =~ s/$pt_dir/$ca_dir/;
	# output
	my $found = 0;
	my $totalLineNum=$#calogs;
	for(my $i=0; $i<=$totalLineNum;$i++) {
		next if ( $calogs[$i] =~ /^$/ );
		if ( $tgt eq $calogs[$i] ) {
			$calogs[$i] = "";
			$found = 1;
			last;
		}
	}
	if ( $found == 0 ) {
		print "*** ADD\n" if ( $printed == 0 );
		$printed = 1;
		print $tgt;
		$addnum++;
	}
}
$printed = 0;
foreach (@calogs) {
	next if ( /^$/ );
	print "*** DELETED \n" if ( $printed == 0 );
	$printed = 1;
	print $_;
	$delnum++;
}
print "DELETE $delnum\n";
print "ADD    $addnum\n";
close($fh);
