#!/usr/bin/perl
#
# $Header: /data/cvsrepo/assess-tools/bin/0007_code-check,v 1.5 2016/01/29 02:23:44 kozeni Exp $
# $Name: rev_1_10 $
#
# ツール名 : 0007_code-check
# Summary : Check the character code used for each line of the file, output the result
# Execution Method : 0007_code-check file
# Input    : file: File name to check
# Outout   : "sjis" : SJIS use
#          : "euc" : euc use
#          : "sjis euc" : SJIS, euc Mixed
#          : "utf8" : utf8 use
#          : "sjis utf8" : SJIS, utf8 Mixed
#          : "euc utf8" : euc, utf8 Mixed
#          : "euc sjis utf8" : euc, SJIS, utf8 Mixed
#          : "jis" : JIS use
#          : "sjis jis" : SJIS, JIS Mixed
#          : "euc jis" : euc, JIS Mixed
#          : "euc sjis jis" : euc, SJIS, JIS Mixed
#          : "utf8 jis" : utf8, JIS Mixed
#          : "sjis utf8 jis" : SJIS, utf8, JIS Mixed
#          : "euc utf8 jis" : euc, utf8, JIS Mixed
#          : "sjis euc utf8 jis" : SJIS, euc, utf8, JIS Mixed
#          : "ascii" : There is no full-width code, or full-width code other than the above, such as UTF-7

use Encode::Guess qw/utf8 cp932 euc-jp 7bit-jis/;

my $filename=$ARGV[0];

if ( $filename eq "" ) {
	print STDERR "Usage : $0 filename\n";
	exit 1;
}

open(my $fh, "$filename") || die("Can't open $filename");

my $encname;
my $code = 0;
while(<$fh>) {
#	print "$. $_ ";
	my $enc = guess_encoding($_);
	if ( ref($enc) ) {
		$encname = $enc->name;
	}
	else {
		# guess_encoding() で特定できない場合、それまでの結果を反映
		# それまでの結果が無い場合はLANG環境変数優先、それも取れなければ
		# utf8 > cp932 > euc-jp > jis の優先順位とする
		if ( $code == 0 && $enc =~ / or / ) {
			my $lang = $ENV{"LANG"};
			if ( $lang =~ /utf8/ ) {
				$encname = "utf8";
			}
			elsif ( $lang =~ /SJIS/ ) {
				$encname = "cp932";
			}
			elsif ( $lang =~ /eucJP/ ) {
				$encname = "euc-jp";
			}
			elsif ( $lang =~ /ISO-2022-JP/ || $lang =~ /JIS7/) {
				$encname = "7bit-jis";
			}
			else {
				if ( $enc =~ /utf8/ ) {
					$encname = "utf8";
				$encname = "utf8";
				}
				elsif ( $enc =~ /cp932/ ) {
					$encname = "cp932";
				}
				elsif ( $enc =~ /euc-jp/ ) {
					$encname = "euc-jp";
				}
				elsif ( $enc =~ /7bit-jis/ ) {
					$encname = "7bit-jis";
				}
				else {
					$encname = "$enc";
				}
			}
		}
		elsif ( $code == 1 && $enc =~ /cp932/ ) {
			$encname = "cp932";
		}
		elsif ( $code == 2 && $enc =~ /euc-jp/ ) {
			$encname = "euc-jp";
		}
		elsif ( $code == 4 && $enc =~ /utf8/ ) {
			$encname = "utf8";
		}
		elsif ( $code == 8 && $enc =~ /7bit-jis/ ) {
			$encname = "7bit-jis";
		}
		else {
			$encname = "$enc";
		}
	}
	
#	last if ( $encname ne "ascii" );
	if ( $encname =~ /cp932/ ) {
		$code |= 1;
	}
	if ( $encname =~ /euc-jp/ ) {
		$code |= 2;
	}
	if ( $encname =~ /utf8/ ) {
		$code |= 4;
	}
	if ( $encname =~ /7bit-jis/ ) {
		$code |= 8;
	}
#	print "$encname $code\n";
}
close($fh);

#use Switch;
#use feature qw/switch/; 
#switch ($code) {
#	case 1	{ print "sjis\n" }
#	case 2	{ print "euc\n" }
#	case 3	{ print "sjis euc\n" }
#	case 4	{ print "utf8\n" }
#	case 5	{ print "sjis utf8\n" }
#	case 6	{ print "euc utf8\n" }
#	case 7	{ print "euc sjis utf8\n" }
#	case 8	{ print "jis\n" }
#	case 9	{ print "sjis jis\n" }
#	case 10	{ print "euc jis\n" }
#	case 11	{ print "euc sjis jis\n" }
#	case 12	{ print "utf8 jis\n" }
#	case 13	{ print "sjis utf8 jis\n" }
#	case 14	{ print "euc utf8 jis\n" }
#	case 15	{ print "sjis euc utf8 jis\n" }
#	else	{ print "ascii\n" }
#}
	if ($code == 1)
	{ print "sjis\n"; }
	if ($code == 2)
	{ print "euc\n"; }
	if ($code ==  3 ) 
	{ print "sjis euc\n"; }
	if ($code == 4) 
	 { print "utf8\n;" }
	if ( $code ==  5 ) { print "sjis utf8\n"; }
        if ( $code ==  6 ) { print "euc utf8\n"; }
        if ( $code ==  7 ) { print "euc sjis utf8\n"; }
        if ( $code ==  8 ) { print "jis\n"; }
        if ( $code ==  9 ) { print "sjis jis\n"; }
        if ( $code ==  10) { print "euc jis\n"; }
        if ( $code ==  11) { print "euc sjis jis\n"; }
        if ( $code ==  12) { print "utf8 jis\n"; }
        if ( $code ==  13) { print "sjis utf8 jis\n"; }
        if ( $code ==  14) { print "euc utf8 jis\n"; }
        if ( $code ==  15) { print "sjis euc utf8 jis\n"; }
	else
        { print "ascii\n"; }
